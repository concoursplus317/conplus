<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Re√ßus - Concours d'√âloquence</title>
    
    <!-- Biblioth√®ques n√©cessaires -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* === RESET === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* === CONTAINER === */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* === HEADER === */
        .header {
            background: linear-gradient(to right, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* === MAIN CONTENT === */
        .main-content {
            padding: 40px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* === FORM === */
        .form-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 18px;
        }

        .code-input {
            width: 100%;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            resize: vertical;
            min-height: 200px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .code-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .counter {
            text-align: right;
            font-size: 14px;
            color: #7f8c8d;
        }

        /* === BUTTONS === */
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        /* === OPTIONS === */
        .options-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-item:hover {
            background: #e9ecef;
        }

        .option-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #3498db;
        }

        .option-item label {
            cursor: pointer;
            margin: 0;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        /* === DOWNLOAD SECTION === */
        .download-section {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-radius: 15px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .download-info {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .download-icon {
            font-size: 60px;
            color: #28a745;
        }

        .file-details {
            flex: 1;
        }

        .file-details h3 {
            color: #155724;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .file-size {
            color: #0c5460;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .download-actions {
            display: flex;
            gap: 15px;
        }

        /* === LOADER === */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loader-content {
            text-align: center;
            max-width: 400px;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 30px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #3498db, #9b59b6);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* === FOOTER === */
        .footer {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
            margin-top: 40px;
        }

        /* === NOTIFICATION === */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üé§ G√©n√©rateur de Re√ßus de Paiement</h1>
            <p>Concours d'√âloquence 2024 ‚Ä¢ 10 re√ßus par page A4</p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Column -->
            <div>
                <!-- Form Section -->
                <div class="form-section">
                    <div class="form-group">
                        <label for="codeInput">üìù Codes de vote (un par ligne)</label>
                        <textarea 
                            id="codeInput" 
                            class="code-input" 
                            placeholder="Entrez les codes, un par ligne :&#10;ELOQ-2024-001&#10;ELOQ-2024-002&#10;ELOQ-2024-003&#10;..."
                            rows="8"
                        >ELOQ-2024-001
ELOQ-2024-002
ELOQ-2024-003
ELOQ-2024-004
ELOQ-2024-005
ELOQ-2024-006
ELOQ-2024-007
ELOQ-2024-008
ELOQ-2024-009
ELOQ-2024-010</textarea>
                        <div class="counter">
                            <span id="codeCount">10</span> codes saisis
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="form-group">
                        <label>‚öôÔ∏è Options de g√©n√©ration</label>
                        <div class="option-item">
                            <input type="checkbox" id="optionWatermark" checked>
                            <label for="optionWatermark">
                                <div style="width: 20px; height: 20px; background: #3498db; opacity: 0.3; margin-right: 10px;"></div>
                                Appliquer le filigrane (IMG_1812.jpeg)
                            </label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="optionSeal" checked>
                            <label for="optionSeal">
                                <div style="width: 20px; height: 20px; border: 2px solid #000; border-radius: 50%; margin-right: 10px;"></div>
                                Ajouter le sceau officiel (Times_New_Roman.png)
                            </label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="optionQRCode" checked>
                            <label for="optionQRCode">
                                <div style="width: 20px; height: 20px; border: 2px solid #000; margin-right: 10px; position: relative;">
                                    <div style="position: absolute; width: 12px; height: 12px; background: #000; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                </div>
                                Inclure les codes QR
                            </label>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="button-group">
                        <button class="btn btn-primary" id="generateBtn">
                            üöÄ G√©n√©rer les Re√ßus PDF
                        </button>
                        <button class="btn btn-secondary" id="previewBtn">
                            üëÅÔ∏è Aper√ßu Rapide
                        </button>
                        <button class="btn btn-secondary" id="clearBtn">
                            üóëÔ∏è Effacer Tout
                        </button>
                        <button class="btn btn-success" id="exampleBtn">
                            üìã Charger Exemple
                        </button>
                    </div>
                </div>

                <!-- Download Section -->
                <div class="download-section" id="downloadSection">
                    <div class="download-info">
                        <div class="download-icon">‚úÖ</div>
                        <div class="file-details">
                            <h3>Re√ßus g√©n√©r√©s avec succ√®s !</h3>
                            <p id="downloadMessage">10 re√ßus pr√™ts √† t√©l√©charger</p>
                            <div class="file-size">
                                <span>üìÑ</span>
                                <span id="fileName">receipts.pdf</span>
                                ‚Ä¢
                                <span id="fileSize">~250 KB</span>
                            </div>
                        </div>
                        <div class="download-actions">
                            <button class="btn btn-primary" id="downloadPDFBtn">
                                üì• T√©l√©charger PDF
                            </button>
                            <button class="btn btn-secondary" id="printBtn">
                                üñ®Ô∏è Imprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="options-section">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä Informations</h3>
                
                <div style="background: #e8f4fc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #3498db; margin-bottom: 10px;">üìù Format des re√ßus</h4>
                    <ul style="padding-left: 20px; color: #2c3e50;">
                        <li>10 re√ßus par page A4</li>
                        <li>2 colonnes √ó 5 lignes</li>
                        <li>Taille : 85mm √ó 45mm</li>
                        <li>Optimis√© pour impression</li>
                    </ul>
                </div>

                <div style="background: #f0f8f0; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">üîí S√©curit√© int√©gr√©e</h4>
                    <ul style="padding-left: 20px; color: #2c3e50;">
                        <li>Filigrane (IMG_1812.jpeg)</li>
                        <li>Sceau officiel (Times_New_Roman.png)</li>
                        <li>Code QR de v√©rification</li>
                        <li>Num√©ro de s√©rie unique</li>
                    </ul>
                </div>

                <div style="background: #fff8e1; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #f39c12; margin-bottom: 10px;">üí° Conseils</h4>
                    <ul style="padding-left: 20px; color: #2c3e50;">
                        <li>Utilisez du papier A4 standard</li>
                        <li>Imprimez en haute qualit√©</li>
                        <li>Conservez une copie num√©rique</li>
                        <li>V√©rifiez avant distribution</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>¬© 2024 Concours d'√âloquence ‚Ä¢ Tous droits r√©serv√©s</p>
            <p style="margin-top: 10px; opacity: 0.8; font-size: 14px;">
                G√©n√©rateur officiel de re√ßus ‚Ä¢ Version 3.0 ‚Ä¢ Sceau officiel int√©gr√©
            </p>
        </div>
    </div>

    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <div class="spinner"></div>
            <h3>G√©n√©ration en cours...</h3>
            <p>Cr√©ation des re√ßus PDF avec sceau officiel</p>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p id="loaderStatus">Initialisation</p>
        </div>
    </div>

    <!-- Sceau officiel cach√© pour pr√©chargement -->
    <img id="officialSeal" src="Times_New_Roman.png" style="display: none;" alt="Sceau Officiel" 
         onload="console.log('‚úÖ Sceau officiel charg√©: Times_New_Roman.png')"
         onerror="console.error('‚ùå Erreur chargement sceau officiel')" />

    <script>
        // ============ VARIABLES GLOBALES ============
        let codes = [];
        let pdfBlob = null;
        let generatedPDF = null;
        let sealImage = null;
        let sealLoaded = false;

        // ============ INITIALISATION ============
        document.addEventListener('DOMContentLoaded', function() {
            updateCodeCount();
            loadFromLocalStorage();
            
            // Pr√©charger le sceau officiel
            preloadOfficialSeal();
            
            // √âv√©nements
            document.getElementById('codeInput').addEventListener('input', updateCodeCount);
            document.getElementById('generateBtn').addEventListener('click', generateReceiptsPDF);
            document.getElementById('previewBtn').addEventListener('click', showQuickPreview);
            document.getElementById('clearBtn').addEventListener('click', clearAll);
            document.getElementById('exampleBtn').addEventListener('click', loadExample);
            document.getElementById('downloadPDFBtn').addEventListener('click', downloadPDF);
            document.getElementById('printBtn').addEventListener('click', printPDF);
            
            // Raccourcis clavier
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            console.log('‚úÖ G√©n√©rateur de re√ßus initialis√©');
        });

        // ============ PR√âCHARGEMENT DU SCEAU OFFICIEL ============
        function preloadOfficialSeal() {
            sealImage = new Image();
            sealImage.crossOrigin = "anonymous"; // Permet l'acc√®s CORS si n√©cessaire
            
            sealImage.onload = function() {
                sealLoaded = true;
                console.log('‚úÖ Sceau officiel charg√© avec succ√®s:', sealImage.src);
                console.log('üìè Dimensions sceau:', sealImage.width + 'x' + sealImage.height);
                showNotification('‚úÖ Sceau officiel charg√©: Times_New_Roman.png', 'success');
            };
            
            sealImage.onerror = function() {
                sealLoaded = false;
                console.error('‚ùå Erreur chargement sceau officiel: Times_New_Roman.png');
                console.log('üîÑ Tentative avec chemin absolu...');
                
                // Tentative avec chemin diff√©rent
                setTimeout(() => {
                    sealImage.src = './Times_New_Roman.png';
                }, 1000);
                
                showNotification('‚ö†Ô∏è Chargement du sceau...', 'info');
            };
            
            // Essayer plusieurs chemins possibles
            const possiblePaths = [
                'Times_New_Roman.png',
                './Times_New_Roman.png',
                'Times_New_Roman.PNG',
                './Times_New_Roman.PNG',
                'times_new_roman.png',
                './times_new_roman.png'
            ];
            
            // Essayer chaque chemin jusqu'√† ce qu'un fonctionne
            let currentPathIndex = 0;
            
            function tryNextPath() {
                if (currentPathIndex < possiblePaths.length) {
                    console.log(`üîÑ Essai chargement sceau: ${possiblePaths[currentPathIndex]}`);
                    sealImage.src = possiblePaths[currentPathIndex];
                    currentPathIndex++;
                    
                    // Essayer le prochain chemin apr√®s 2 secondes si √©chec
                    setTimeout(() => {
                        if (!sealLoaded && currentPathIndex < possiblePaths.length) {
                            tryNextPath();
                        }
                    }, 2000);
                }
            }
            
            tryNextPath();
        }

        // ============ FONCTIONS PRINCIPALES ============

        // Mettre √† jour le compteur de codes
        function updateCodeCount() {
            const text = document.getElementById('codeInput').value.trim();
            codes = text.split('\n')
                .map(code => code.trim())
                .filter(code => code.length > 0);
            
            document.getElementById('codeCount').textContent = codes.length;
            saveToLocalStorage();
        }

        // G√©n√©rer les re√ßus PDF AVEC SCEAU
        async function generateReceiptsPDF() {
            if (codes.length === 0) {
                showNotification('‚ùå Veuillez entrer au moins un code', 'error');
                return;
            }

            showLoader('Pr√©paration des re√ßus...');
            
            try {
                // Options
                const options = {
                    watermark: document.getElementById('optionWatermark').checked,
                    seal: document.getElementById('optionSeal').checked,
                    qrcode: document.getElementById('optionQRCode').checked
                };

                // G√©n√©rer le PDF
                const pdf = await createPDFWithSeal(codes, options);
                
                // Sauvegarder le PDF
                pdfBlob = pdf.output('blob');
                generatedPDF = pdf;
                
                // Mettre √† jour l'interface
                updateDownloadSection();
                showDownloadSection();
                
                hideLoader();
                showNotification(`‚úÖ ${codes.length} re√ßu(s) g√©n√©r√©(s) avec succ√®s`, 'success');
                
            } catch (error) {
                console.error('Erreur g√©n√©ration PDF:', error);
                hideLoader();
                showNotification('‚ùå Erreur lors de la g√©n√©ration: ' + error.message, 'error');
            }
        }

        // Cr√©er le PDF AVEC SCEAU OFFICIEL
        async function createPDFWithSeal(codes, options) {
            return new Promise(async (resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const pageWidth = 210;
                    const pageHeight = 297;
                    const margin = 20;
                    const receiptWidth = 85;
                    const receiptHeight = 45;
                    const cols = 2;
                    const rows = 5;
                    const horizontalGap = (pageWidth - 2 * margin - cols * receiptWidth) / (cols - 1);
                    const verticalGap = (pageHeight - 2 * margin - rows * receiptHeight) / (rows - 1);

                    let receiptIndex = 0;

                    // V√©rifier si le sceau est disponible
                    const useSeal = options.seal && sealLoaded;
                    
                    if (options.seal && !sealLoaded) {
                        console.warn('‚ö†Ô∏è Sceau non charg√©, utilisation de texte');
                        showNotification('‚ö†Ô∏è Sceau non trouv√©, utilisation du texte', 'warning');
                    }

                    // G√©n√©rer les re√ßus page par page
                    for (let page = 0; page < Math.ceil(codes.length / 10); page++) {
                        if (page > 0) {
                            pdf.addPage();
                        }

                        // D√©finir la police
                        pdf.setFont('helvetica');
                        pdf.setFontSize(8);

                        // G√©n√©rer 10 re√ßus par page
                        for (let row = 0; row < rows; row++) {
                            for (let col = 0; col < cols; col++) {
                                if (receiptIndex >= codes.length) break;

                                const x = margin + col * (receiptWidth + horizontalGap);
                                const y = margin + row * (receiptHeight + verticalGap);
                                const code = codes[receiptIndex];
                                
                                // Dessiner le cadre du re√ßu
                                pdf.setDrawColor(0, 0, 0);
                                pdf.setLineWidth(0.5);
                                pdf.rect(x, y, receiptWidth, receiptHeight);

                                // Ajouter le filigrane (si activ√©)
                                if (options.watermark) {
                                    pdf.setTextColor(200, 200, 200);
                                    pdf.setFontSize(40);
                                    pdf.text('√âLOQUENCE', x + receiptWidth/2, y + receiptHeight/2, { 
                                        align: 'center', 
                                        angle: 45 
                                    });
                                    pdf.setTextColor(0, 0, 0);
                                    pdf.setFontSize(8);
                                }

                                // En-t√™te
                                pdf.setFontSize(10);
                                pdf.setFont('helvetica', 'bold');
                                pdf.text('RE√áU DE PAIEMENT', x + receiptWidth/2, y + 5, { align: 'center' });
                                pdf.setFont('helvetica', 'normal');
                                pdf.text('Concours d\'√âloquence 2024', x + receiptWidth/2, y + 8, { align: 'center' });
                                pdf.setFontSize(8);

                                // Ligne de s√©paration
                                pdf.line(x + 5, y + 10, x + receiptWidth - 5, y + 10);

                                // Informations
                                const now = new Date();
                                const dateStr = now.toLocaleDateString('fr-FR');
                                const timeStr = now.toLocaleTimeString('fr-FR').slice(0, 5);
                                const ref = `REF-${now.getFullYear()}-${String(receiptIndex + 1).padStart(4, '0')}`;

                                pdf.text(`Date: ${dateStr}`, x + 5, y + 15);
                                pdf.text(`Heure: ${timeStr}`, x + 5, y + 18);
                                pdf.text(`R√©f: ${ref}`, x + 5, y + 21);
                                pdf.text(`Montant: 50,00 ‚Ç¨`, x + 5, y + 24);

                                // Code de vote
                                pdf.setFont('courier', 'bold');
                                pdf.setFontSize(10);
                                pdf.text('CODE DE VOTE:', x + receiptWidth/2, y + 30, { align: 'center' });
                                pdf.setFontSize(12);
                                pdf.setTextColor(220, 53, 69);
                                pdf.text(code, x + receiptWidth/2, y + 35, { align: 'center' });
                                pdf.setTextColor(0, 0, 0);
                                pdf.setFont('helvetica', 'normal');
                                pdf.setFontSize(8);

                                // QR Code (simul√© - si activ√©)
                                if (options.qrcode) {
                                    pdf.setDrawColor(100, 100, 100);
                                    pdf.rect(x + receiptWidth - 20, y + 28, 15, 15);
                                    pdf.text('QR', x + receiptWidth - 12.5, y + 35.5, { align: 'center' });
                                }

                                // SCEAU OFFICIEL - Times_New_Roman.png
                                if (useSeal) {
                                    try {
                                        // Calculer la taille du sceau (proportionnellement)
                                        const sealMaxWidth = 25; // mm
                                        const sealMaxHeight = 12; // mm
                                        
                                        // Calculer les dimensions proportionnelles
                                        let sealWidth = sealMaxWidth;
                                        let sealHeight = (sealImage.height / sealImage.width) * sealWidth;
                                        
                                        if (sealHeight > sealMaxHeight) {
                                            sealHeight = sealMaxHeight;
                                            sealWidth = (sealImage.width / sealImage.height) * sealHeight;
                                        }
                                        
                                        // Position du sceau (en bas √† droite)
                                        const sealX = x + receiptWidth - sealWidth - 5;
                                        const sealY = y + receiptHeight - sealHeight - 5;
                                        
                                        // Ajouter l'image du sceau
                                        pdf.addImage(
                                            sealImage,
                                            'PNG',
                                            sealX,
                                            sealY,
                                            sealWidth,
                                            sealHeight
                                        );
                                        
                                        // Ajouter un texte descriptif
                                        pdf.setFontSize(6);
                                        pdf.setTextColor(100, 100, 100);
                                        pdf.text('Sceau Officiel', sealX + sealWidth/2, sealY - 1, { align: 'center' });
                                        pdf.setTextColor(0, 0, 0);
                                        
                                    } catch (imageError) {
                                        console.error('‚ùå Erreur ajout sceau:', imageError);
                                        // Fallback: texte si l'image ne peut √™tre ajout√©e
                                        pdf.setFontSize(8);
                                        pdf.text('SCEAU OFFICIEL', x + receiptWidth - 40, y + receiptHeight - 5);
                                        pdf.line(x + receiptWidth - 40, y + receiptHeight - 6, x + receiptWidth - 10, y + receiptHeight - 6);
                                    }
                                } else if (options.seal) {
                                    // Fallback: texte si l'option est coch√©e mais l'image n'est pas charg√©e
                                    pdf.setFontSize(8);
                                    pdf.text('SCEAU OFFICIEL', x + receiptWidth - 40, y + receiptHeight - 5);
                                    pdf.line(x + receiptWidth - 40, y + receiptHeight - 6, x + receiptWidth - 10, y + receiptHeight - 6);
                                }

                                // Num√©ro de s√©quence
                                pdf.setFontSize(6);
                                pdf.setTextColor(100, 100, 100);
                                pdf.text(`${receiptIndex + 1}/${codes.length}`, x + receiptWidth - 8, y + 4);
                                pdf.setTextColor(0, 0, 0);

                                receiptIndex++;
                            }
                        }

                        // Num√©ro de page
                        pdf.setFontSize(10);
                        pdf.text(`Page ${page + 1}`, pageWidth/2, pageHeight - 10, { align: 'center' });

                        // Mettre √† jour la progression
                        const progress = Math.min((receiptIndex / codes.length) * 100, 90);
                        updateProgress(progress);
                        
                        // Petit d√©lai pour √©viter le blocage
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }

                    updateProgress(100);
                    resolve(pdf);

                } catch (error) {
                    reject(error);
                }
            });
        }

        // Mettre √† jour la section de t√©l√©chargement
        function updateDownloadSection() {
            const fileSize = pdfBlob ? Math.round(pdfBlob.size / 1024) : 0;
            const pageCount = Math.ceil(codes.length / 10);
            
            document.getElementById('downloadMessage').textContent = 
                `${codes.length} re√ßu(s) ‚Ä¢ ${pageCount} page(s) A4`;
            document.getElementById('fileName').textContent = 
                `recus_eloquence_${new Date().toISOString().slice(0,10)}.pdf`;
            document.getElementById('fileSize').textContent = `${fileSize} KB`;
        }

        // T√©l√©charger le PDF
        function downloadPDF() {
            if (!generatedPDF) {
                showNotification('‚ùå Aucun PDF √† t√©l√©charger', 'error');
                return;
            }

            const filename = `recus_concours_eloquence_${new Date().toISOString().slice(0,19).replace(/[:]/g, '-')}.pdf`;
            generatedPDF.save(filename);
            showNotification('üì• T√©l√©chargement d√©marr√©', 'success');
        }

        // Imprimer le PDF
        function printPDF() {
            if (!generatedPDF) {
                showNotification('‚ùå Aucun PDF √† imprimer', 'error');
                return;
            }

            // Cr√©er une nouvelle fen√™tre pour l'impression
            const printWindow = window.open('', '_blank');
            const pdfDataUri = generatedPDF.output('datauristring');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Impression des Re√ßus</title>
                    <style>
                        body { margin: 0; padding: 0; }
                        iframe { width: 100%; height: 100vh; border: none; }
                    </style>
                </head>
                <body>
                    <iframe src="${pdfDataUri}"></iframe>
                    <script>
                        window.onload = function() {
                            setTimeout(function() {
                                document.querySelector('iframe').contentWindow.print();
                            }, 1000);
                        };
                    <\/script>
                </body>
                </html>
            `);
        }

        // ============ FONCTIONS UTILITAIRES ============

        // Afficher l'aper√ßu rapide
        function showQuickPreview() {
            if (codes.length === 0) {
                showNotification('‚ùå Veuillez entrer des codes', 'error');
                return;
            }

            // Cr√©er un aper√ßu avec le sceau
            const previewWindow = window.open('', '_blank', 'width=600,height=800');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Aper√ßu Re√ßu - Avec Sceau Officiel</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                        .preview-container { 
                            width: 400px; 
                            margin: 0 auto; 
                            background: white;
                            padding: 20px;
                            border-radius: 10px;
                            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                        }
                        .receipt { 
                            width: 300px; 
                            border: 2px solid #000; 
                            padding: 20px; 
                            margin: 20px auto;
                            position: relative;
                            background: white;
                        }
                        .seal-preview {
                            width: 100px;
                            height: 50px;
                            border: 2px dashed #3498db;
                            margin: 20px auto;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: #f8f9fa;
                        }
                        h2 { text-align: center; margin: 0 0 10px 0; color: #2c3e50; }
                        .code { 
                            text-align: center; 
                            font-size: 24px; 
                            font-weight: bold; 
                            color: #c00; 
                            margin: 20px 0; 
                            font-family: monospace;
                            padding: 10px;
                            background: #f8f9fa;
                            border-radius: 5px;
                        }
                        .info { 
                            margin: 10px 0; 
                            padding: 8px;
                            border-bottom: 1px solid #eee;
                        }
                    </style>
                </head>
                <body>
                    <div class="preview-container">
                        <h1>üìã Aper√ßu du Re√ßu</h1>
                        
                        <div class="receipt">
                            <h2>RE√áU DE PAIEMENT</h2>
                            <div class="info"><strong>Concours d'√âloquence 2024</strong></div>
                            <div class="info">Date: ${new Date().toLocaleDateString('fr-FR')}</div>
                            <div class="info">Heure: ${new Date().toLocaleTimeString('fr-FR').slice(0,5)}</div>
                            <div class="info">Code: <span class="code">${codes[0]}</span></div>
                            <div class="info">Montant: 50,00 ‚Ç¨</div>
                            
                            <div style="text-align: center; margin-top: 30px;">
                                <div class="seal-preview">
                                    SCEAU OFFICIEL<br>
                                    <small>(Times_New_Roman.png)</small>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
                            <p>‚úÖ Le PDF final inclura le vrai sceau officiel</p>
                            <p>üìÑ ${codes.length} re√ßu(s) seront g√©n√©r√©s</p>
                            <p>üìë ${Math.ceil(codes.length / 10)} page(s) A4</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        // Effacer tout
        function clearAll() {
            if (codes.length > 0 && confirm('√ätes-vous s√ªr de vouloir tout effacer ?')) {
                document.getElementById('codeInput').value = '';
                codes = [];
                updateCodeCount();
                document.getElementById('downloadSection').style.display = 'none';
                showNotification('üóëÔ∏è Tous les codes ont √©t√© effac√©s', 'info');
            }
        }

        // Charger un exemple
        function loadExample() {
            const example = [];
            for (let i = 1; i <= 12; i++) {
                example.push(`ELOQ-2024-${String(i).padStart(3, '0')}`);
            }
            document.getElementById('codeInput').value = example.join('\n');
            updateCodeCount();
            showNotification('üìã Exemple charg√© (12 codes)', 'success');
        }

        // Afficher la section de t√©l√©chargement
        function showDownloadSection() {
            document.getElementById('downloadSection').style.display = 'block';
            document.getElementById('downloadSection').scrollIntoView({ behavior: 'smooth' });
        }

        // ============ GESTION DU LOADER ============

        function showLoader(message) {
            document.getElementById('loaderStatus').textContent = message;
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('progressBar').style.width = '0%';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('loaderStatus').textContent = 
                `G√©n√©ration... ${Math.round(percent)}%`;
        }

        // ============ NOTIFICATIONS ============

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <span style="font-size: 24px;">${icons[type] || '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background:none; border:none; font-size:24px; cursor:pointer; margin-left:auto; color: #666;">√ó</button>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // ============ LOCAL STORAGE ============

        function saveToLocalStorage() {
            localStorage.setItem('eloquenceCodes', JSON.stringify(codes));
            localStorage.setItem('eloquenceOptions', JSON.stringify({
                watermark: document.getElementById('optionWatermark').checked,
                seal: document.getElementById('optionSeal').checked,
                qrcode: document.getElementById('optionQRCode').checked
            }));
        }

        function loadFromLocalStorage() {
            const savedCodes = localStorage.getItem('eloquenceCodes');
            const savedOptions = localStorage.getItem('eloquenceOptions');
            
            if (savedCodes) {
                codes = JSON.parse(savedCodes);
                if (codes.length > 0) {
                    document.getElementById('codeInput').value = codes.join('\n');
                    updateCodeCount();
                }
            }
            
            if (savedOptions) {
                const options = JSON.parse(savedOptions);
                document.getElementById('optionWatermark').checked = options.watermark;
                document.getElementById('optionSeal').checked = options.seal;
                document.getElementById('optionQRCode').checked = options.qrcode;
            }
        }

        // ============ RACCOURCIS CLAVIER ============

        function handleKeyboardShortcuts(e) {
            // Ctrl+Enter : G√©n√©rer
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                generateReceiptsPDF();
            }
            
            // Ctrl+E : Exemple
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                loadExample();
            }
            
            // Ctrl+D : T√©l√©charger
            if (e.ctrlKey && e.key === 'd' && generatedPDF) {
                e.preventDefault();
                downloadPDF();
            }
            
            // Ctrl+P : Imprimer
            if (e.ctrlKey && e.key === 'p' && generatedPDF) {
                e.preventDefault();
                printPDF();
            }
        }

        // ============ FONCTIONS EXPORT√âES ============
        window.downloadPDF = downloadPDF;
        window.printPDF = printPDF;
    </script>
</body>
</html>