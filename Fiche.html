<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Re√ßus - Concours d'√âloquence</title>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* === STYLES DE BASE (inchang√©s) === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(to right, #2c3e50, #34495e); color: white; padding: 30px; text-align: center; }
        .main-content { padding: 40px; display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        @media (max-width: 992px) { .main-content { grid-template-columns: 1fr; } }
        .form-section { background: #f8f9fa; padding: 30px; border-radius: 10px; border: 2px solid #e9ecef; }
        .code-input { width: 100%; padding: 20px; border: 2px solid #ddd; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 16px; resize: vertical; min-height: 200px; margin-bottom: 15px; }
        .button-group { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 30px; }
        .btn { padding: 15px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; }
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .download-section { margin-top: 40px; padding: 30px; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 15px; display: none; }
        .loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 1000; align-items: center; justify-content: center; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1001; }
    </style>
</head>
<body>
    <div class="container">
        <!-- En-t√™te -->
        <div class="header">
            <h1>üé§ G√©n√©rateur de Re√ßus de Paiement</h1>
            <p>Concours d'√âloquence 2024 ‚Ä¢ 10 re√ßus par page A4</p>
        </div>

        <!-- Contenu principal -->
        <div class="main-content">
            <!-- Colonne gauche -->
            <div>
                <!-- Formulaire -->
                <div class="form-section">
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50; font-size: 18px;">
                            üìù Codes de vote (un par ligne)
                        </label>
                        <textarea 
                            id="codeInput" 
                            class="code-input" 
                            placeholder="Entrez les codes, un par ligne :&#10;ELOQ-2024-001&#10;ELOQ-2024-002&#10;ELOQ-2024-003&#10;..."
                            rows="8"
                        >ELOQ-2024-001
ELOQ-2024-002
ELOQ-2024-003
ELOQ-2024-004
ELOQ-2024-005
ELOQ-2024-006
ELOQ-2024-007
ELOQ-2024-008
ELOQ-2024-009
ELOQ-2024-010</textarea>
                        <div style="text-align: right; font-size: 14px; color: #7f8c8d;">
                            <span id="codeCount">10</span> codes saisis
                        </div>
                    </div>

                    <!-- Options -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50; font-size: 18px;">
                            ‚öôÔ∏è Options de g√©n√©ration
                        </label>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <input type="checkbox" id="optionWatermark" checked style="width: 20px; height: 20px;">
                            <label for="optionWatermark" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <div style="width: 20px; height: 20px; background: #3498db; opacity: 0.3;"></div>
                                Filigrane (IMG_1812.jpeg)
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <input type="checkbox" id="optionSeal" checked style="width: 20px; height: 20px;">
                            <label for="optionSeal" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <div style="width: 20px; height: 20px; border: 2px solid #000; border-radius: 50%;"></div>
                                Sceau officiel (Times_New_Roman.png)
                            </label>
                        </div>
                    </div>

                    <!-- Boutons -->
                    <div class="button-group">
                        <button class="btn btn-primary" id="generateBtn">
                            üöÄ G√©n√©rer les Re√ßus PDF
                        </button>
                        <button class="btn" style="background: #95a5a6; color: white;" id="previewBtn">
                            üëÅÔ∏è Aper√ßu
                        </button>
                        <button class="btn" style="background: #95a5a6; color: white;" id="clearBtn">
                            üóëÔ∏è Effacer
                        </button>
                    </div>
                </div>

                <!-- Section t√©l√©chargement -->
                <div class="download-section" id="downloadSection">
                    <div style="display: flex; align-items: center; gap: 25px;">
                        <div style="font-size: 60px; color: #28a745;">‚úÖ</div>
                        <div style="flex: 1;">
                            <h3 style="color: #155724; margin-bottom: 10px; font-size: 24px;">
                                Re√ßus g√©n√©r√©s avec succ√®s !
                            </h3>
                            <p id="downloadMessage">10 re√ßus pr√™ts √† t√©l√©charger</p>
                            <div style="color: #0c5460; display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                                <span>üìÑ</span>
                                <span id="fileName">recus_eloquence.pdf</span>
                                ‚Ä¢
                                <span id="fileSize">~250 KB</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <button class="btn btn-primary" id="downloadPDFBtn">
                                üì• T√©l√©charger PDF
                            </button>
                            <button class="btn" style="background: #95a5a6; color: white;" id="printBtn">
                                üñ®Ô∏è Imprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonne droite -->
            <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä Configuration du Sceau</h3>
                
                <!-- Upload du sceau -->
                <div style="margin-bottom: 25px;">
                    <p style="color: #666; margin-bottom: 15px;">
                        Pour que le sceau s'affiche correctement :
                    </p>
                    <div style="border: 2px dashed #3498db; border-radius: 10px; padding: 20px; text-align: center; background: #f8f9fa;">
                        <div style="font-size: 40px; margin-bottom: 10px;">üñºÔ∏è</div>
                        <p style="color: #2c3e50; margin-bottom: 10px;">
                            <strong>√âtape 1 :</strong> Assurez-vous que l'image est dans le dossier
                        </p>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                            Nom : <code>Times_New_Roman.png</code><br>
                            Format : PNG recommand√©
                        </p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button id="testSealBtn" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Tester le chargement
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pr√©visualisation du sceau -->
                <div style="margin-bottom: 25px;">
                    <p style="color: #2c3e50; margin-bottom: 10px; font-weight: 600;">
                        Aper√ßu du sceau :
                    </p>
                    <div id="sealPreview" style="border: 2px solid #ddd; border-radius: 5px; padding: 20px; text-align: center; background: white; min-height: 100px; display: flex; align-items: center; justify-content: center;">
                        <div style="color: #999;">
                            <div>üì∑</div>
                            <div style="font-size: 12px; margin-top: 5px;">Chargement...</div>
                        </div>
                    </div>
                </div>

                <!-- Statut du sceau -->
                <div id="sealStatus" style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107;">
                    <p style="color: #856404; margin: 0;">
                        <strong>‚ö†Ô∏è Important :</strong> Le sceau doit √™tre accessible via URL publique
                    </p>
                </div>
            </div>
        </div>

        <!-- Pied de page -->
        <div style="background: #2c3e50; color: white; padding: 30px; text-align: center; margin-top: 40px;">
            <p>¬© 2024 Concours d'√âloquence ‚Ä¢ Tous droits r√©serv√©s</p>
            <p style="margin-top: 10px; opacity: 0.8; font-size: 14px;">
                G√©n√©rateur officiel de re√ßus ‚Ä¢ Version 3.1 ‚Ä¢ Sceau officiel int√©gr√©
            </p>
        </div>
    </div>

    <!-- Loader -->
    <div class="loader" id="loader">
        <div style="text-align: center; max-width: 400px; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="width: 80px; height: 80px; margin: 0 auto 30px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <h3>G√©n√©ration en cours...</h3>
            <p id="loaderStatus">Pr√©paration des re√ßus</p>
            <div style="height: 8px; background: #eee; border-radius: 4px; margin: 30px 0; overflow: hidden;">
                <div id="progressBar" style="height: 100%; background: linear-gradient(to right, #3498db, #9b59b6); width: 0%; transition: width 0.3s ease; border-radius: 4px;"></div>
            </div>
        </div>
    </div>

    <!-- Image cach√©e pour le sceau -->
    <img id="sealImage" src="Times_New_Roman.png" style="display: none;" 
         onload="console.log('‚úÖ Image du sceau charg√©e'); sealLoaded=true; updateSealPreview();"
         onerror="console.log('‚ùå Erreur chargement sceau'); sealLoaded=false; updateSealPreview();" />

    <script>
        // ============ VARIABLES GLOBALES ============
        let codes = [];
        let sealLoaded = false;
        let sealImageBase64 = null;
        let generatedPDF = null;

        // ============ INITIALISATION ============
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initialisation du g√©n√©rateur');
            
            updateCodeCount();
            loadSealImage();
            
            // √âv√©nements
            document.getElementById('codeInput').addEventListener('input', updateCodeCount);
            document.getElementById('generateBtn').addEventListener('click', generatePDFWithSeal);
            document.getElementById('previewBtn').addEventListener('click', showPreview);
            document.getElementById('clearBtn').addEventListener('click', clearAll);
            document.getElementById('downloadPDFBtn').addEventListener('click', downloadPDF);
            document.getElementById('printBtn').addEventListener('click', printPDF);
            document.getElementById('testSealBtn').addEventListener('click', testSealLoading);
        });

        // ============ CHARGEMENT DU SCEAU ============
        function loadSealImage() {
            console.log('üîÑ Chargement du sceau officiel...');
            
            const img = document.getElementById('sealImage');
            const sealPreview = document.getElementById('sealPreview');
            
            // Convertir l'image en Base64 pour jsPDF
            convertImageToBase64('Times_New_Roman.png')
                .then(base64 => {
                    sealImageBase64 = base64;
                    sealLoaded = true;
                    console.log('‚úÖ Sceau converti en Base64');
                    
                    // Afficher la pr√©visualisation
                    sealPreview.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 30px; color: #28a745; margin-bottom: 10px;">‚úÖ</div>
                            <p style="color: #28a745; font-weight: 600; margin-bottom: 5px;">Sceau charg√© avec succ√®s !</p>
                            <p style="color: #666; font-size: 12px;">Pr√™t pour l'int√©gration PDF</p>
                        </div>
                    `;
                    
                    // Mettre √† jour le statut
                    document.getElementById('sealStatus').innerHTML = `
                        <p style="color: #155724; margin: 0;">
                            <strong>‚úÖ Pr√™t :</strong> Le sceau sera int√©gr√© dans tous les re√ßus
                        </p>
                    `;
                    
                    showNotification('‚úÖ Sceau officiel charg√© avec succ√®s', 'success');
                })
                .catch(error => {
                    console.error('‚ùå Erreur conversion sceau:', error);
                    sealPreview.innerHTML = `
                        <div style="text-align: center; color: #dc3545;">
                            <div style="font-size: 30px;">‚ùå</div>
                            <p style="font-weight: 600; margin: 10px 0;">Sceau non trouv√©</p>
                            <p style="font-size: 12px;">V√©rifiez que Times_New_Roman.png est dans le dossier</p>
                        </div>
                    `;
                    
                    showNotification('‚ùå Sceau officiel non trouv√©', 'error');
                });
        }

        // Convertir image en Base64
        function convertImageToBase64(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    try {
                        const base64 = canvas.toDataURL('image/png');
                        resolve(base64);
                    } catch (e) {
                        reject(new Error('Erreur conversion Base64'));
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('Erreur chargement image'));
                };
                
                img.src = url + '?t=' + new Date().getTime();
            });
        }

        // Tester le chargement du sceau
        function testSealLoading() {
            showNotification('üîÑ Test du chargement du sceau...', 'info');
            loadSealImage();
        }

        // Mettre √† jour la pr√©visualisation
        function updateSealPreview() {
            const sealPreview = document.getElementById('sealPreview');
            if (sealLoaded) {
                sealPreview.innerHTML = `
                    <img src="Times_New_Roman.png" style="max-width: 150px; max-height: 80px; border: 1px solid #ddd; padding: 5px; background: white;" 
                         onerror="this.style.display='none'" />
                `;
            }
        }

        // ============ G√âN√âRATION PDF ============
        async function generatePDFWithSeal() {
            if (codes.length === 0) {
                showNotification('‚ùå Veuillez entrer au moins un code', 'error');
                return;
            }

            showLoader('Cr√©ation des re√ßus...');
            
            try {
                // Options
                const useWatermark = document.getElementById('optionWatermark').checked;
                const useSeal = document.getElementById('optionSeal').checked;
                
                // Cr√©er le PDF
                const pdf = await createReceiptsPDF(codes, useWatermark, useSeal);
                generatedPDF = pdf;
                
                // Mettre √† jour l'interface
                updateDownloadSection();
                document.getElementById('downloadSection').style.display = 'block';
                
                hideLoader();
                showNotification(`‚úÖ ${codes.length} re√ßu(s) g√©n√©r√©(s)`, 'success');
                
            } catch (error) {
                console.error('Erreur:', error);
                hideLoader();
                showNotification('‚ùå Erreur g√©n√©ration PDF: ' + error.message, 'error');
            }
        }

        // Cr√©er les re√ßus PDF
        async function createReceiptsPDF(codes, useWatermark, useSeal) {
            return new Promise((resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const pageWidth = 210;
                    const pageHeight = 297;
                    const margin = 20;
                    const receiptWidth = 85;
                    const receiptHeight = 45;
                    const cols = 2;
                    const rows = 5;
                    const horizontalGap = (pageWidth - 2 * margin - cols * receiptWidth) / (cols - 1);
                    const verticalGap = (pageHeight - 2 * margin - rows * receiptHeight) / (rows - 1);

                    let receiptIndex = 0;

                    // G√©n√©rer page par page
                    for (let page = 0; page < Math.ceil(codes.length / 10); page++) {
                        if (page > 0) {
                            pdf.addPage();
                        }

                        pdf.setFont('helvetica');
                        pdf.setFontSize(8);

                        // 10 re√ßus par page
                        for (let row = 0; row < rows; row++) {
                            for (let col = 0; col < cols; col++) {
                                if (receiptIndex >= codes.length) break;

                                const x = margin + col * (receiptWidth + horizontalGap);
                                const y = margin + row * (receiptHeight + verticalGap);
                                const code = codes[receiptIndex];
                                
                                // Cadre du re√ßu
                                pdf.setDrawColor(0, 0, 0);
                                pdf.setLineWidth(0.5);
                                pdf.rect(x, y, receiptWidth, receiptHeight);

                                // Filigrane
                                if (useWatermark) {
                                    pdf.setTextColor(200, 200, 200);
                                    pdf.setFontSize(40);
                                    pdf.text('√âLOQUENCE', x + receiptWidth/2, y + receiptHeight/2, { 
                                        align: 'center', 
                                        angle: 45 
                                    });
                                    pdf.setTextColor(0, 0, 0);
                                    pdf.setFontSize(8);
                                }

                                // En-t√™te
                                pdf.setFontSize(10);
                                pdf.setFont('helvetica', 'bold');
                                pdf.text('RE√áU DE PAIEMENT', x + receiptWidth/2, y + 5, { align: 'center' });
                                pdf.setFont('helvetica', 'normal');
                                pdf.text('Concours d\'√âloquence 2024', x + receiptWidth/2, y + 8, { align: 'center' });
                                pdf.setFontSize(8);

                                // Ligne de s√©paration
                                pdf.line(x + 5, y + 10, x + receiptWidth - 5, y + 10);

                                // Informations
                                const now = new Date();
                                const dateStr = now.toLocaleDateString('fr-FR');
                                const timeStr = now.toLocaleTimeString('fr-FR').slice(0, 5);
                                const ref = `REF-${now.getFullYear()}-${String(receiptIndex + 1).padStart(4, '0')}`;

                                pdf.text(`Date: ${dateStr}`, x + 5, y + 15);
                                pdf.text(`Heure: ${timeStr}`, x + 5, y + 18);
                                pdf.text(`R√©f: ${ref}`, x + 5, y + 21);
                                pdf.text(`Montant: 50,00 ‚Ç¨`, x + 5, y + 24);

                                // Code de vote
                                pdf.setFont('courier', 'bold');
                                pdf.setFontSize(10);
                                pdf.text('CODE DE VOTE:', x + receiptWidth/2, y + 30, { align: 'center' });
                                pdf.setFontSize(12);
                                pdf.setTextColor(220, 53, 69);
                                pdf.text(code, x + receiptWidth/2, y + 35, { align: 'center' });
                                pdf.setTextColor(0, 0, 0);
                                pdf.setFont('helvetica', 'normal');
                                pdf.setFontSize(8);

                                // SCEAU OFFICIEL - CORRECTION ICI
                                if (useSeal && sealImageBase64) {
                                    try {
                                        // Dimensions du sceau
                                        const sealWidth = 20;
                                        const sealHeight = 10;
                                        
                                        // Position (en bas √† droite)
                                        const sealX = x + receiptWidth - sealWidth - 5;
                                        const sealY = y + receiptHeight - sealHeight - 5;
                                        
                                        // IMPORTANT: Utiliser addImage avec Base64
                                        pdf.addImage(
                                            sealImageBase64, // Base64 de l'image
                                            'PNG',           // Format
                                            sealX,           // X
                                            sealY,           // Y
                                            sealWidth,       // Largeur
                                            sealHeight       // Hauteur
                                        );
                                        
                                        // Texte sous le sceau
                                        pdf.setFontSize(6);
                                        pdf.setTextColor(100, 100, 100);
                                        pdf.text('Sceau Officiel', sealX + sealWidth/2, sealY - 1, { align: 'center' });
                                        pdf.setTextColor(0, 0, 0);
                                        
                                    } catch (sealError) {
                                        console.error('Erreur ajout sceau:', sealError);
                                        // Fallback texte
                                        pdf.setFontSize(8);
                                        pdf.text('SCEAU OFFICIEL', x + receiptWidth - 40, y + receiptHeight - 5);
                                    }
                                } else if (useSeal) {
                                    // Sceau texte si pas d'image
                                    pdf.setFontSize(8);
                                    pdf.text('SCEAU OFFICIEL', x + receiptWidth - 40, y + receiptHeight - 5);
                                }

                                // Num√©ro de s√©quence
                                pdf.setFontSize(6);
                                pdf.setTextColor(100, 100, 100);
                                pdf.text(`${receiptIndex + 1}/${codes.length}`, x + receiptWidth - 8, y + 4);
                                pdf.setTextColor(0, 0, 0);

                                receiptIndex++;
                                
                                // Mettre √† jour la progression
                                updateProgress(Math.min((receiptIndex / codes.length) * 100, 90));
                            }
                        }

                        // Num√©ro de page
                        pdf.setFontSize(10);
                        pdf.text(`Page ${page + 1}`, pageWidth/2, pageHeight - 10, { align: 'center' });
                    }

                    updateProgress(100);
                    resolve(pdf);

                } catch (error) {
                    reject(error);
                }
            });
        }

        // ============ FONCTIONS UTILITAIRES ============

        function updateCodeCount() {
            const text = document.getElementById('codeInput').value.trim();
            codes = text.split('\n')
                .map(code => code.trim())
                .filter(code => code.length > 0);
            document.getElementById('codeCount').textContent = codes.length;
        }

        function showPreview() {
            if (codes.length === 0) {
                showNotification('‚ùå Entrez d\'abord des codes', 'error');
                return;
            }
            
            const previewWindow = window.open('', '_blank', 'width=600,height=800');
            previewWindow.document.write(`
                <html>
                <head><title>Aper√ßu Re√ßu</title></head>
                <body style="font-family: Arial; padding: 20px;">
                    <h1>üìã Aper√ßu du Re√ßu avec Sceau</h1>
                    <div style="border: 2px solid #000; padding: 20px; width: 300px; margin: 20px auto; position: relative;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <h2 style="margin: 0;">RE√áU DE PAIEMENT</h2>
                            <p style="color: #666;">Concours d'√âloquence 2024</p>
                        </div>
                        <div style="border-top: 1px solid #000; padding-top: 15px;">
                            <p><strong>Date:</strong> ${new Date().toLocaleDateString('fr-FR')}</p>
                            <p><strong>Code:</strong> <span style="color: red; font-weight: bold;">${codes[0]}</span></p>
                            <p><strong>Montant:</strong> 50,00 ‚Ç¨</p>
                        </div>
                        <div style="text-align: right; margin-top: 30px; padding-top: 10px; border-top: 1px solid #000;">
                            <div style="border: 1px dashed #3498db; width: 100px; height: 50px; margin-left: auto; display: flex; align-items: center; justify-content: center; color: #666;">
                                SCEAU OFFICIEL
                            </div>
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">(Times_New_Roman.png sera int√©gr√©)</p>
                        </div>
                    </div>
                    <p style="text-align: center; color: #666; margin-top: 30px;">
                        ‚úÖ Le PDF final contiendra ${codes.length} re√ßu(s) avec le sceau officiel
                    </p>
                </body>
                </html>
            `);
        }

        function clearAll() {
            if (codes.length > 0 && confirm('Effacer tous les codes ?')) {
                document.getElementById('codeInput').value = '';
                codes = [];
                updateCodeCount();
                document.getElementById('downloadSection').style.display = 'none';
                showNotification('üóëÔ∏è Codes effac√©s', 'info');
            }
        }

        function downloadPDF() {
            if (!generatedPDF) {
                showNotification('‚ùå G√©n√©rer d\'abord les re√ßus', 'error');
                return;
            }
            
            const filename = `recus_concours_eloquence_${new Date().toISOString().slice(0,19).replace(/[:]/g, '-')}.pdf`;
            generatedPDF.save(filename);
            showNotification('üì• T√©l√©chargement d√©marr√©', 'success');
        }

        function printPDF() {
            if (!generatedPDF) {
                showNotification('‚ùå G√©n√©rer d\'abord les re√ßus', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const pdfDataUri = generatedPDF.output('datauristring');
            printWindow.document.write(`
                <html><head><title>Impression</title></head>
                <body><iframe src="${pdfDataUri}" width="100%" height="100%" style="border: none;"></iframe>
                <script>setTimeout(() => window.print(), 1000);<\/script>
                </body></html>
            `);
        }

        function updateDownloadSection() {
            const pageCount = Math.ceil(codes.length / 10);
            document.getElementById('downloadMessage').textContent = 
                `${codes.length} re√ßu(s) ‚Ä¢ ${pageCount} page(s) A4`;
            document.getElementById('fileName').textContent = 
                `recus_eloquence_${new Date().toISOString().slice(0,10)}.pdf`;
        }

        function showLoader(message) {
            document.getElementById('loaderStatus').textContent = message;
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('progressBar').style.width = '0%';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('progressBar').style.width = '100%';
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = `${percent}%`;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'error' ? '#f8d7da' : 
                                          type === 'success' ? '#d4edda' : '#d1ecf1';
            notification.style.color = type === 'error' ? '#721c24' : 
                                      type === 'success' ? '#155724' : '#0c5460';
            notification.style.borderLeft = type === 'error' ? '4px solid #dc3545' : 
                                           type === 'success' ? '4px solid #28a745' : '4px solid #17a2b8';
            
            notification.innerHTML = `
                <span style="font-size: 20px;">${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background:none; border:none; font-size:20px; cursor:pointer; margin-left:auto;">√ó</button>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // CSS pour l'animation du spinner
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>